<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Survey for {{ country }}</title>
  <!-- Load jQuery, jQuery UI, and Bootstrap from CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- Include Crowd HTML Elements Library -->
  <script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
  <!-- Define some custom CSS styles -->
  <style>
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 800px;
      margin: auto;
    }

    .image {
      width: 200px;
      height: 200px;
      margin: 10px;
      border: 1px solid black;
    }

    .number {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 24px;
      font-weight: bold;
    }

    .sortable {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .rating {
      display: flex;
      justify-content: center;
      margin: 10px;
    }

    .radio {
      display: none;
    }

    .label {
      display: inline-block;
      width: 30px;
      height: 30px;
      margin: 5px;
      border: 1px solid black;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      cursor: pointer;
    }

    .radio:checked + .label {
      background-color: green;
      color: white;
    }

    .answer {
      display: none;
    }

    .likert {
      display: flex;
      justify-content: space-between;
      margin: 10px;
    }

    .likert input {
      margin: 0 5px;
    }

    .alert {
      display: none;
    }
  </style>
</head>
<body>
  <crowd-form>
    <div class="container">
        {% for survey_item in survey_items %}
            <div class="item">
                <h2>{{ survey_item['item_title'] }}</h2>
                <p>{{ survey_item['item_text'] }}</p>
                {% if survey_item['item_type'] == 'Rank' %}
                    <div class="sortable">
                        {% for i in range(1, number_of_images + 1) %}
                            <div data-id="{{ i }}" class="image">
                                <span class="number">{{ i }}</span>
                                <img src="{{ survey_item['image' ~ i] }}" alt="Image {{ i }}">
                            </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" class="answer" name="answer_{{ loop.index }}" value="">
                    <div class="alert">Please rank all images.</div>
                {% elif survey_item['item_type'] == 'Likert' %}
                    <div class="likert">
                        {% for i in range(1, survey_item['Likert Steps'] + 1) %}
                            <label>{{ i }}<input type="radio" class="radio" name="answer_{{ loop.index }}" value="{{ i }}"></label>
                        {% endfor %}
                    </div>
                    <div class="alert">Please select a rating.</div>
                {% endif %}
                <!-- Add conditions for other item types if needed -->
            </div>
        {% endfor %}
    </div>
    <!-- Additional Crowd HTML Elements for Mechanical Turk -->
    <short-instructions>
        <p>Rank the images or provide ratings as instructed.</p>
    </short-instructions>
    <full-instructions>
        <p>Follow the instructions carefully and provide your rankings or ratings accordingly.</p>
        <!-- Additional detailed instructions go here -->
    </full-instructions>
</crowd-form>


  <script>
    // Get the worker ID, the seed, and the assignment ID from the URL
    var workerId = turkGetParam("workerId");
    var seed = turkGetParam("seed");
    var assignmentId = turkGetParam("assignmentId");
    // Create a random number generator based on the worker ID and the seed
    var random = new Math.seedrandom(workerId + seed);
    // Loop through the items
    $(".item").each(function() {
      // Get the item type, the sortable element, the answer element, and the alert element
      var type = $(this).find(".answer").attr("name").slice(0, 6);
      var sortable = $(this).find(".sortable");
      var answer = $(this).find(".answer");
      var alert = $(this).find(".alert");
      // If the item type is "answer", do the following
      if (type == "answer") {
        // Get the number of images
        var n = sortable.children().length;
        // Shuffle the images based on the random number generator
        for (var i = n - 1; i > 0; i--) {
          var j = Math.floor(random() * (i + 1));
          var temp = sortable.children()[i];
          sortable.insertBefore(sortable.children()[j], sortable.children()[i]);
          sortable.insertBefore(temp, sortable.children()[j]);
        }
        // Update the numbers on the images
        for (var i = 0; i < n; i++) {
          sortable.children()[i].querySelector(".number").textContent = i + 1;
        }
        // Make the images draggable and sortable using jQuery UI
        sortable.sortable({
          update: function(event, ui) {
            // Update the numbers on the images
            for (var i = 0; i < n; i++) {
              sortable.children()[i].querySelector(".number").textContent = i + 1;
            }
            // Update the answer value
            var order = sortable.sortable("toArray", {attribute: "data-id"});
            answer.val(order.join(","));
          }
        });
        sortable.disableSelection();
        // Validate the answer before submitting
        answer.on("change", function() {
          // If the answer is empty or incomplete, show the alert and prevent submission
          if (answer.val().split(",").length < n) {
            alert.show();
            turkSetAssignmentID("ASSIGNMENT_ID_NOT_AVAILABLE");
          } else {
            // Otherwise, hide the alert and allow submission
            alert.hide();
            turkSetAssignmentID(assignmentId);
          }
        });
      } else if (type == "likert") {
        // Get the likert element, the answer element, and the alert element
        var likert = $(this).find(".likert");
        var answer = $(this).find(".answer");
        var alert = $(this).find(".alert");
        // Validate the answer before submitting
        likert.on("change", function() {
          // If the answer is empty or incomplete, show the alert and prevent submission
          if (likert.find(":checked").length === 0) {
            alert.show();
            turkSetAssignmentID("ASSIGNMENT_ID_NOT_AVAILABLE");
          } else {
            // Otherwise, hide the alert and allow submission
            alert.hide();
            turkSetAssignmentID(assignmentId);
          }
          // Update the answer value
          answer.val(likert.find(":checked").val() || "");
        });
      }
    });
  </script>
</body>
</html>
